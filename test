
import React from 'react';
import { Dropdown } from 'your-dropdown-component-library'; // Adjust import according to your library

class YourComponent extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      YearOptions: [],
      dummyItems: [],
      selectedYear: "",
      items: [],
      isLoading: false,
    };
  }

  componentDidMount() {
    this.getCurrentFiscalYear();
  }

  getCurrentFiscalYear = () => {
    const today = new Date();
    const fiscalYearStartMonth = 6; // July is month 6 (zero-based index)
    let fiscalYear;
    if (today.getMonth() + 1 >= fiscalYearStartMonth) {
      fiscalYear = `${today.getFullYear().toString().slice(-2)}-${(
        today.getFullYear() + 1
      )
        .toString()
        .slice(-2)}`;
    } else {
      fiscalYear = `${(today.getFullYear() - 1).toString().slice(-2)}-${today
        .getFullYear()
        .toString()
        .slice(-2)}`;
    }
    this.setState({ selectedYear: `FY ${fiscalYear}` }, this.getItems);
  };

  parseFinancialYear = (fyString) => {
    let yearPart = fyString.split(" ")[1];
    return parseInt(yearPart, 10);
  };

  getItems = () => {
    if (
      this.props.userRights.isAdmin ||
      this.props.userRights.isMember ||
      this.props.userRights.isVisitor
    ) {
      let selectFields = [
        "Id",
        "NameOfIssuerParentEntity",
        "LeadEngagementPartner/Title",
        "LeadEngagementPartner/EMail",
        "LeadAuditSeniorManager/Title",
        "FormStatus",
        "Designee/Title",
        "Modified",
        "EQRPartner/Title",
        "Designee/EMail",
        "Title",
        "Year",
      ];
      let query = sp.web.lists
        .getByTitle(Constants.PCAOBListName)
        .items.select(selectFields.join(","))
        .expand(
          "Designee, LeadEngagementPartner, EQRPartner, LeadAuditSeniorManager"
        );
      let filter = `FormStatus ne '${Constants.formStatus.archived}' and FormStatus ne '${Constants.formStatus.deleted}'`;
      if (this.props.userRights.isMember) {
        filter += ` and (Designee/EMail eq '${this.props.context.pageContext.user.email}' or LeadEngagementPartner/EMail eq '${this.props.context.pageContext.user.email}')`;
      }
      this.setState({ isLoading: true });

      let finalYearData = [];
      const uniqueYears = new Set();

      query
        .filter(filter)
        .top(2000)
        .orderBy("Modified", false)
        .get()
        .then((resp) => {
          let items = [];
          resp.map((item) => {
            items.push({
              Id: item.Id,
              NameOfIssuerParentEntity: item.NameOfIssuerParentEntity,
              LeadEngagementPartner:
                item.LeadEngagementPartner && item.LeadEngagementPartner.Title,
              LeadEngagementPartnerMail:
                item.LeadEngagementPartner && item.LeadEngagementPartner.EMail,
              LeadAuditSeniorManager:
                item.LeadAuditSeniorManager &&
                item.LeadAuditSeniorManager.Title,
              FormStatus: item.FormStatus,
              Designee: item.Designee && item.Designee.Title,
              Modified: item.Modified,
              EQRPartner: item.EQRPartner && item.EQRPartner.Title,
              DesigneeMail: item.Designee && item.Designee.EMail,
              Title: item.Title,
              Year: item.Year,
            });
            if (item.Year) {
              uniqueYears.add(item.Year);
            }
          });

          uniqueYears.forEach((year) => {
            finalYearData.push({ key: year, text: year.toString() });
          });

          finalYearData.sort(
            (a, b) =>
              this.parseFinancialYear(b.key) - this.parseFinancialYear(a.key)
          );

          const filteredItems = items.filter(
            (each) => each.Year === this.state.selectedYear
          );

          this.setState({
            items: filteredItems,
            dummyItems: items,
            isLoading: false,
            YearOptions: finalYearData,
          });
        })
        .catch((ex) => {
          console.log("Failed to get items", ex);
          this.setState({ items: [], isLoading: false });
        });
    }
  };

  render() {
    return (
      <Dropdown
        onChange={(e, option) => {
          const filteredItems = this.state.dummyItems.filter(
            (each) => each.Year === option.text
          );
          this.setState({
            selectedYear: option.text,
            items: filteredItems,
          });
        }}
        selectedKey={this.state.selectedYear}
        placeholder="Year"
        options={this.state.YearOptions}
        styles={this.dropdownStyles}
        style={{ outlineColor: "transparent", width: "150px" }}
      />
    );
  }
}

export default YourComponent;
